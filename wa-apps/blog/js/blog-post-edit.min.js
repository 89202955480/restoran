(function(a){a.wa_blog.editor={options:{blogs:{},content_id:"post_text",current_blog_id:null,dateMonthCount:2,dateShowWeek:!1,cut_link_label_default:"",version:"1.0"},transliterated:!1,blog_statuses:{"private":"private","public":"public"},init:function(b){function c(b){a(this).show();a(this).parent().find(".datetime").hide();b&&a("#current-time").text(b);a("#current-time").show()}function d(a){var b=a.siblings(".hint:first");0>=b.length&&(b=a.parent().siblings(".hint:first"));return b}function e(a){a.parent().find("input[type=text]").removeClass("error");
d(a).removeClass("errormsg")}function h(a){a.parent().find("input[type=text]").addClass("error");d(a).addClass("errormsg")}function j(){return a.datepicker._defaults.dateFormat.toUpperCase().replace("YY","YYYY")}var f=this;f.options=a.extend(f.options,b);var n=function(b){if(b){var d=b.link+b.slug+"/";a("#url-link").text(d);a("#url-link").attr("href",b.preview_hash?d+"?preview="+b.preview_hash:d);a("#pure-url").text(b.link);b.slug&&!g?(a("#post-url").val(b.slug),g=b.slug):a("#post-url").val(g);var c=
b.is_adding?"small":b.is_published?"small":"hint",e=a("#post-url-field span:first").contents().filter(function(){return this.nodeType==3}).get(0).nodeValue;if(b.other_links&&b.other_links instanceof Array){d=[];for(k in b.other_links)d.push({previewText:e,className:c,slug:g,link:b.other_links[k],href:b.preview_hash?b.other_links[k]+g+"/?preview="+b.preview_hash:b.other_links[k]+g+"/"});b=b.is_adding?'<span class="${className}">${previewText}${link}<span class="slug">{{if slug}}${slug}/{{/if}}</span></span><br>':
'<span class="${className}">${previewText}<a target="_blank" href="${href}">${link}<span class="slug">{{if slug}}${slug}/{{/if}}</span></a></span><br>';c=a("#post-url-field").children(":first");c.is(".icon10")&&(b='<i class="'+c.attr("class")+'"></i> '+b);a("#other-urls").html(a.tmpl(b,d))}}a("#post-url-field").show("fast")},m=function(){a("#post-url-field").hide("fast");a("#post-url").val("")},t=function(b,d){b&&(g=b);a(".slug").each(function(){if(g){var b=a(this).text(g+"/").parents("a:first");
b.attr("href",b.text()+(d?"?preview="+d:""))}else a(this).text("")})},b=function(){a("#url-editable").hide();a("#url-edit").show();a("#post-url").focus()},o,g=null,p={},l=function(){};!a("#post-url-field").length||a("#post-url-field").hasClass("no-settlements")?l=function(b){b==a.wa_blog.editor.blog_statuses["public"]?n():m()}:(o=function(){var b=a("input[name=post_id]").val();if(!b&&!this.value)m();else{var d=a("input[name=blog_id]").val(),c=this.value,e=null,f={post_title:c,post_id:b,blog_id:d},
h=[d,b,c].join("&");p[h]?(b=p[h])&&!b.is_private_blog?n(b):m():(null!=g&&(f.slug=g),a.ajax({url:"?module=post&action=getPostUrl",data:f,dataType:"json",type:"post",async:!1,success:function(b){e=b.data;p[h]=e;a.wa_blog.editor.transliterated=!0;e&&!e.is_private_blog?n(e):m()}}))}},a("#post-form").find("input[name=post_id]").val()||a("#post-title").blur(function(){var a=this;setTimeout(function(){null==g&&o.call(a)},200)}),l=function(){o.call(a("#post-title").get(0))},a("#url-edit-link").click(b),a("#post-url").keyup(function(a){9!=
a.keyCode&&this.value!=g&&t(this.value)}));f.postUrlWidget={setEditReady:b,resetEditReady:function(){a("#url-editable").show();a("#url-edit").hide()},updateSlugs:t,changeBlog:l};var b={beforeSave:function(){var b=a(".datepicker:not(:disabled)"),d=true;if(b.length>0){var c=b.parent(".datetime").find(".time");if(c.length>0){var e;if(e=c.get(0)){e=c.eq(0).val();e=!(e>=0&&e<=24)}e&&(d=false);if(e=c.get(1)){c=c.eq(1).val();e=!(c>=0&&c<=60)}e&&(d=false)}d||h(b)}if(!d)return false;a.wa_blog.editor.onSubmit()},
afterSave:function(b){a("#b-post-save-button").removeClass("yellow").addClass("green");a("#postpublish-edit").removeClass("yellow").addClass("green");f.postUrlWidget.resetEditReady();f.postUrlWidget.updateSlugs(b.url,b.preview_hash||false);c.call(a("#inline-edit-datetime").get(0),b.formatted_datetime);f.inlineSaveController.getAction()=="draft"&&a("#post-url-field .small").removeClass("small").addClass("hint");b=a("#b-post-edit-custom-params-dialog");if(!b.is(":hidden")){var d=b.find(":input[name=meta_title]").val(),
e=b.find(":input[name=meta_keywords]").val(),h=b.find(":input[name=meta_description]").val(),g=b.find(":input[name=params]").val();d?a("#b-post-edit-meta-title").show().find(".val").text(d):a("#b-post-edit-meta-title").hide();e?a("#b-post-edit-meta-keywords").show().find(".val").text(e):a("#b-post-edit-meta-keywords").hide();h?a("#b-post-edit-meta-description").show().find(".val").text(h):a("#b-post-edit-meta-description").hide();g?a("#b-post-edit-custom-params").show().html(g.trim().split("\n").join("<br>")+
"<br>"):a("#b-post-edit-custom-params").hide();d||e||h||g?a("#b-post-edit-no-meta").hide():a("#b-post-edit-no-meta").show();b.trigger("close")}}},u=function(){if(v()!==false){var b=w,d=a.wa_blog.editor.wysiwygToHtml(a("#post_text","#post-form").val());a("#post_text","#post-form").val(d);d=a("#post-form").serialize()+"&"+i+"=1";d=d+(q?"&inline=1":"");d=d+(!a.wa_blog.editor.transliterated?"&transliterate=1":"");b=b||function(){};r("loading");a.ajax({url:"?module=post&action=save",data:d,dataType:"json",
type:"post",success:function(d){if(d.status=="fail"){d.errors.datetime||a.wa_blog.editor.closeCurrentDialog();var c=d.errors;if(c.url){a("#post-url-field").show();var e=a("#post-url"),f=c.url,g="#message-"+e.attr("id");e.addClass("error");a(g).addClass("errormsg").text(f)}if(c.datetime){c=a(".datepicker:not(:disabled)");c.length&&h(c)}if(!d.errors.datetime&&i=="deadline"){(d=a("#deadline-dialog .datepicker").val())?a("#publication-deadline-changable-part").html(a.tmpl("publication-deadline-setted",
{date:d})):a("#publication-deadline-changable-part").html(a.tmpl("publication-deadline-setted"));a("#b-post-save-draft-button").attr("name","deadline")}}else if(d.data.redirect)location.href=d.data.redirect;else{b(d.data);d.data.id&&a("#post-id").val(d.data.id);r("saved")}q=false;r("")},error:function(){}})}},r=function(b,d){if(b){a("#form-status span").hide();a("#form-status #"+b+"-status").show();a("#form-status").show()}else a("#form-status").fadeOut(d&&typeof d=="function"?d:function(){})},b=
b||{},i="",q=!1,v=b.beforeSave||function(){},w=b.afterSave||function(){};a("input[type=submit], input[type=button], a.js-submit").click(function(){if(a(this).hasClass("dialog-edit"))return false;if(a(this).hasClass("js-submit")){var b=a(this).attr("title")||a(this).text()||"Are you sure?";if(!confirm(b))return false}if(a("#post-id").val()&&(this.id=="b-post-save-button"||this.id=="b-post-save-draft-button"||this.id=="b-post-save-custom-params"))q=true;i=this.name;(i=="deadline"||i=="schedule")&&a("#"+
this.name+"-dialog").find("input[name^=datetime]").attr("disabled",false);u();return false});a("#post-url").focus(function(){});f.inlineSaveController={save:u,setAction:function(a){i=a},getAction:function(){return i}};b=function(){var b="#"+this.id+"-on-label",d="#"+this.id+"-off-label";if(this.checked){a(b).removeClass("b-unselected");a(d).addClass("b-unselected")}else{a(b).addClass("b-unselected");a(d).removeClass("b-unselected")}};l=a("#allow-comment-switcher");b.call(l.get(0));l.iButton({labelOn:"",
labelOff:"",className:"mini"}).change(b);b=f.options;b={changeMonth:!0,changeYear:!0,shortYearCutoff:2,showOtherMonths:2>b.dateMonthCount,selectOtherMonths:2>b.dateMonthCount,stepMonths:b.dateMonthCount,numberOfMonths:b.dateMonthCount,showWeek:b.dateShowWeek,gotoCurrent:!0,constrainInput:!1,beforeShow:function(){setTimeout(function(){a("#ui-datepicker-div").css("z-index")<10&&a("#ui-datepicker-div").css("z-index",10)},0)}};a(".datepicker").datepicker(b).filter("input[name^=schedule_datetime]").datepicker("option",
"minDate",new Date);a("#ui-datepicker-div").hide();a(".datepicker").focus(function(){e(a(this))});var x=function(){var b=a(this).attr("id").replace(/-.*$/,"");a.wa_blog.editor.currentDialog=a("#"+b+"-dialog").waDialog({disableButtonsOnSubmit:true,onLoad:function(){a(this).find("input,select").removeAttr("disabled");a(".user-date-format").text(j())},onSubmit:function(){return false},onCancel:function(){a(this).find("input:text,select").each(function(){a(this).value=a(this).defaultValue;a(this).attr("disabled",
"disabled")})}});return false};a(".dialog-edit").each(function(){a(this).click(function(a){a.preventDefault();return x.call(a.target)})});b=null;try{b=a.storage.get("blog/editor")}catch(s){this.log("Exception: "+s.message+"\nline: "+s.fileName+":"+s.lineNumber)}if(b)b=b.replace(/\W+/g,"");else for(b in this.editors)break;if(!this.selectEditor(b,!0))for(b in this.editors)if(this.selectEditor(b,!0))break;a.wa.dropdownsCloseEnable();a(".change-blog").click(a.wa_blog.editor.changeBlogHandler);a('#postpublish-dialog input[name="publish_blog_id"]').change(a.wa_blog.editor.changePublishBlogHandler);
a("#post-title").keyup(function(){var b=a(this),d=b.next(".maxlength"),c=parseInt(b.attr("maxlength"));c&&b.val().length>=c&&!d.length?b.after('<em class="hint maxlength">'+$_("input_maxlength").replace(/%d/,c)+"</em>"):(!c||b.val().length<c)&&d.length&&d.remove()});a("#inline-edit-datetime").click(function(){a(this).hide();a(this).parent().find(".datetime").show();a("#current-time").hide();a(".user-date-format").text(j())});a(".b-post-editor-toggle li a").click(this.editorTooggle);a(document).keydown(function(a){if(a.ctrlKey&&
a.keyCode==83)f.onSaveHotkey(a)});a(".time").focus(function(){e(a(this).parent().find(".datepicker"))});a("#post-form").submit(function(){return false});a("#b-post-edit-custom-params-link").click(function(){a("#b-post-edit-custom-params-dialog").waDialog({onSubmit:function(){return false}});return false})},cloneTextarea:function(b,c,d){var e="editor_container_"+d;a(c).append(b.clone(!0).attr({id:e,name:"text_"+d,disabled:!0}));b.hide();return e},cut_hr:'<span class="b-elrte-wa-split-vertical" id="elrte-wa_post_cut">%text%</span>',
cut_str:"<\!-- more %text%--\>",htmlToWysiwyg:function(b){return b.replace(/<\!--[\s]*?more[\s]*?(text[\s]*?=[\s]*?['"]([\s\S]*?)['"])*[\s]*?--\>/g,function(b,d,e){return e?a.wa_blog.editor.cut_hr.replace("%text%",e):a.wa_blog.editor.cut_hr.replace("%text%",a.wa_blog.editor.options.cut_link_label_default)})},wysiwygToHtml:function(b){var c=a("<p></p>").html(a(b));if(c.find("#elrte-wa_post_cut").length){var b=c.find("#elrte-wa_post_cut"),d=b.html();!d||"<br>"===d||d===a.wa_blog.editor.options.cut_link_label_default?
b.replaceWith(a.wa_blog.editor.cut_str.replace("%text%","")):b.replaceWith(a.wa_blog.editor.cut_str.replace("%text%",'text="'+d+'" '));return c.html()}return b},editors:{ace:{editor:null,container:null,inited:!1,init:function(b){if(!this.inited){this.inited=!0;this.container=a('<div id="blog-ace-editor"></div>').appendTo("#post_text_wrapper");this.container.wrap('<div class="ace"></div>');a.wa_blog.editor.calcEditorHeight();this.editor=ace.edit("blog-ace-editor");ace.config.set("basePath",wa_url+
"wa-content/js/ace/");this.editor.setTheme("ace/theme/eclipse");var c=this.editor.getSession();c.setMode("ace/mode/javascript");c.setMode("ace/mode/css");c.setMode("ace/mode/html");c.setMode("ace/mode/smarty");c.setUseWrapMode(!0);this.editor.renderer.setShowGutter(!1);this.editor.setShowPrintMargin(!1);this.editor.setFontSize(13);a(".ace_editor").css("fontFamily","");c.setValue(b.hide().val());this.editor.focus();this.editor.moveCursorTo(0,0);this.editor.commands.addCommand({name:"unfind",bindKey:{win:"Ctrl-F",
mac:"Command-F"},exec:function(){return!1},readOnly:!0});var d=function(b,d){var c=b.getSession().getScreenLength()*b.renderer.lineHeight+b.renderer.scrollBar.getWidth(),c=1.02*c,e=a("#post-form .sidebar:first .b-edit-options").height()-163;c<e&&(c=e);a("#"+d).height(c.toString()+"px");b.resize()},e=this;c.on("change",function(){d(e.editor,"blog-ace-editor")});setTimeout(function(){d(e.editor,"blog-ace-editor")},50);a(window).resize(function(){e.editor.resize();d(e.editor,"blog-ace-editor")});this.container.on("keydown",
a.wa_blog.editor.editorKeyCallback());this.container.on("keypress",a.wa_blog.editor.editorKeyCallback(!0))}return!0},show:function(b){this.container.show();this.container.parent().show();var c=this;setTimeout(function(){if(c.editor){var d=a.wa_blog.editor.wysiwygToHtml(b.val()),e=c.editor.getCursorPosition();c.editor.setValue(d);c.editor.focus();c.editor.navigateTo(e.row,e.column)}else"object"==typeof console&&console.log("wait for ace editor init"),c.show(b)},100)},hide:function(){this.container.hide();
this.container.parent().hide()},update:function(a){this.inited&&a.val(this.editor.getValue())},correctEditorHeight:function(b){return Math.max(b,a.wa_blog.editor.getMinEditorHeight())+a.wa_blog.editor.getExtHeightShift()}},redactor:{options:{},inited:!1,callback:!1,init:function(b){if(!this.inited){var c=a.extend({deniedTags:!1,minHeight:300,buttonSource:!1,paragraphy:!0,convertDivs:!0,toolbarFixedBox:!0,buttons:"html formatting bold italic underline deleted unorderedlist orderedlist outdent indent image video file table link alignment | horizontalrule".split(" "),
plugins:"fontcolor fontsize fontfamily table video cut".split(" "),lang:wa_lang,imageUpload:"?module=pages&action=uploadimage&filelink=1&absolute=1",uploadImageFields:b.data("uploadFields"),imageUploadErrorCallback:function(a){alert(a.error)},syncBeforeCallback:function(a){return a=a.replace(/{[a-z$][^}]*}/gi,function(a,b,d){var c=d.indexOf("<\/script",b+a.length),b=d.indexOf("<script",b+a.length);if(-1==c||-1!=b&&b<c)a=a.replace(/&gt;/g,">"),a=a.replace(/&lt;/g,"<"),a=a.replace(/&amp;/g,"&"),a=a.replace(/&quot;/g,
'"');return a})},changeCallback:function(){a("#postpublish-edit").is(":visible")&&a("#postpublish-edit").removeClass("green").addClass("yellow");a("#b-post-save-button").is(":visible")&&a("#b-post-save-button").removeClass("green").addClass("yellow")}},c||{});b.redactor(c);b.redactor("core.getBox").css("z-index",0);b.redactor("core.getToolbar").css("z-index",1);this.inited=!0}return!0},show:function(b){var c=a.wa_blog.editor.htmlToWysiwyg(b.val());b.val(c);a(".redactor-box").show();b.redactor("core.getEditor").find('img[src*="$wa_url"]').each(function(){var b=
decodeURIComponent(a(this).attr("src"));a(this).attr("data-src",b);a(this).attr("src",b.replace(/\{\$wa_url\}/,wa_url))});b.redactor("code.set",b.val());b.redactor("observe.load");b.redactor("focus.setStart")},hide:function(){a(".redactor-box").hide()},update:function(a){this.inited&&a.val(a.redactor("code.get"))}}},getMinEditorHeight:function(){return 200},getExtHeightShift:function(){return-70},calcEditorHeight:function(){var b=a(document.documentElement).height(),c=a("#post-editor").offset(),d=
a("#buttons-bar").outerHeight(!0);return height=b-c.top-d},editorTooggle:function(){var b=a(this);!b.hasClass("selected")&&a.wa_blog.editor.selectEditor(b.attr("id"))&&(a(".b-post-editor-toggle li.selected").removeClass("selected"),b.parent().addClass("selected"));return!1},selectEditor:function(b,c){if(this.editors[b]){var d=a("#"+this.options.content_id);if(d.length){try{if(this.editors[b].init(d)){var e=null;if(!c)try{a.storage.set("blog/editor",b)}catch(h){this.log("Exception: "+h.message+"\nline: "+
h.fileName+":"+h.lineNumber)}var j=a(".b-post-editor-toggle li.selected a");if(j.length&&(j.parent().removeClass("selected"),e=j.attr("id")))this.editors[e].update(d),this.editors[e].hide();a("#"+b).parent().addClass("selected");this.editors[b].show(d)}}catch(f){return this.log("Exception: "+f.message+"\nline: "+f.fileName+":"+f.lineNumber,f.stack),!1}return!0}this.log('Text container for "'+b+'" not found');return!1}this.log('Blog editor "'+b+'" not found');return!1},editor_key:!1,editorKeyCallback:function(b){var c=
this;return b?function(b){if(b.ctrlKey&&115==b.which&&!a.wa_blog.editor.editor_key)c.onSaveHotkey(b)}:function(b){a.wa_blog.editor.editor_key=!1;b.ctrlKey&&83==b.which&&(a.wa_blog.editor.editor_key=!0,c.onSaveHotkey(b));if(!b.metaKey&&(33>b.which||40<b.which)&&(27<b.which||8==b.which||13==b.which)&&(112>b.which||124<b.which)&&(!b.ctrlKey||67!=b.which))a("#b-post-save-button").removeClass("green").addClass("yellow"),a("#postpublish-edit").removeClass("green").addClass("yellow")}},onSubmit:function(){var b=
a.wa_blog,c;for(c in b)if("editor"!=c&&b[c].onSubmit&&"function"==typeof b[c].onSubmit)try{b[c].onSubmit()}catch(d){"object"==typeof console&&console.log(d)}b=a("#"+this.options.content_id);if(b.length){c=null;var e=a(".b-post-editor-toggle li.selected a");e.length&&(c=e.attr("id"))&&this.editors[c].update(b)}b=a("#b-post-save-button");"draft"==b.attr("name")||"deadline"==b.attr("name")||(b.removeClass("yellow").addClass("green"),a("#postpublish-edit").removeClass("yellow").addClass("green"))},onSaveHotkey:function(b){b.preventDefault();
var b=a("#b-post-save-draft-button"),c=a("#b-post-save-button");b.length?b.click():c.length&&c.click()},currentDialog:null,closeCurrentDialog:function(){this.currentDialog&&this.currentDialog.waDialog().trigger("close")},registerEditor:function(a,c){if(this.editors[a])return this.log('Editor "'+a+'" already registered'),!1;this.editors[a]=c;return!0},log:function(a,c){"object"==typeof console&&(console.log(a),c&&console.log(c))},changeBlogHandler:function(){var b=parseInt(a(this).attr("href").replace(/^.*#/,
""));a.wa_blog.editor.selectCurrentBlog(b)&&(a(".dialog :input:checked").attr("checked",!1),a(".dialog #b-post-publish-blog-"+b).attr("checked",!0));a.wa.dropdownsClose();return!1},changePublishBlogHandler:function(){if(a(this).attr("checked")){var b=parseInt(a(this).val());a.wa_blog.editor.selectCurrentBlog(b)}},selectCurrentBlog:function(b){var c=a.wa_blog.editor.options.blogs[b],d=a.wa_blog.editor.options.current_blog_id;if(c&&d!=b){var e=a.tmpl("selected-blog",{blog:c});a(".current-blog").replaceWith(e);
a("#blog-selector-"+d).removeClass("selected");e=a("#blog-selector-"+b).addClass("selected");d=a.wa_blog.editor.options.blogs[d];a.wa_blog.editor.options.current_blog_id=parseInt(b);b=a(".b-post");d&&b.removeClass(d.color);b.addClass(c.color);a.wa_blog.editor.postUrlWidget.changeBlog(e.attr("data-blog-status"));return!0}}}})(jQuery);
